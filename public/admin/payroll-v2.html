<!doctype html>
<html lang="id" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payroll - NearMe Laundry</title>
  <link rel="stylesheet" href="/styles.css" />
  <script src="/shared/nav.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="min-h-full flex flex-col bg-slate-100" onload="NearMeNav.ensureRole(['admin'])">
  <header class="bg-white shadow-sm">
    <div class="mx-auto max-w-5xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="/icon.JPG" alt="Logo" class="h-8 w-8 rounded-full object-cover" />
        <div>
          <div class="font-semibold text-primary text-sm">NearMe Laundry - Admin</div>
          <div class="text-[11px] text-slate-500">Payroll Karyawan</div>
        </div>
      </div>
      <nav class="flex items-center gap-3 text-[11px] text-slate-600">
        <a href="/admin/dashboard.html">Dashboard</a>
        <a href="/admin/omzet.html">Omzet</a>
        <a href="/admin/payroll-v2.html" class="text-primary font-semibold">Payroll</a>
        <a href="/admin/komisi.html">Komisi</a>
        <a href="/admin/stok.html">Stok</a>
        <a href="/admin/outlet.html">Outlet</a>
        <a href="/admin/users.html">User</a>
        <button onclick="NearMeNav.logout()" class="ml-2 text-red-500">Keluar</button>
      </nav>
    </div>
  </header>

  <main class="flex-1 mx-auto w-full max-w-5xl px-4 py-4">
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3 mb-4">
      <div>
        <h1 class="text-lg font-semibold">Payroll Karyawan</h1>
        <p class="text-xs text-slate-500">Atur gaji, lembur, tunjangan, dan potongan.</p>
      </div>
      <div class="flex items-center gap-2 text-xs">
        <select id="outlet" class="rounded-lg border px-2 py-1">
          <option value="">Semua Outlet</option>
        </select>
        <select id="month" class="rounded-lg border px-2 py-1">
          <option value="1">Januari</option><option value="2">Februari</option>
          <option value="3">Maret</option><option value="4">April</option>
          <option value="5">Mei</option><option value="6">Juni</option>
          <option value="7">Juli</option><option value="8">Agustus</option>
          <option value="9">September</option><option value="10">Oktober</option>
          <option value="11">November</option><option value="12">Desember</option>
        </select>
        <input type="number" id="year" class="w-20 rounded-lg border px-2 py-1" />
        <button onclick="loadPayroll()" class="btn-secondary py-1">Tampilkan</button>
      </div>
    </div>

    <!-- Daftar Karyawan -->
    <div class="card mb-4">
      <h2 class="text-sm font-semibold mb-3">Daftar Karyawan</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-xs">
          <thead>
            <tr class="text-left text-slate-500 border-b">
              <th class="py-2">Nama</th>
              <th class="py-2">Role</th>
              <th class="py-2 text-right">Gaji Pokok</th>
              <th class="py-2 text-right">Pendapatan</th>
              <th class="py-2 text-right">Potongan</th>
              <th class="py-2 text-right">Gaji Bersih</th>
              <th class="py-2 text-right">Aksi</th>
            </tr>
          </thead>
          <tbody id="payroll-body" class="divide-y"></tbody>
        </table>
      </div>
    </div>

    <!-- Form Edit Payroll -->
    <div id="edit-form" class="card hidden">
      <h2 class="text-sm font-semibold mb-3">Edit Payroll: <span id="edit-name"></span></h2>
      <form id="payroll-form" class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <input type="hidden" id="edit_user_id" />
        
        <div>
          <label class="block text-xs text-slate-600 mb-1">Gaji Pokok</label>
          <input type="number" id="gaji_pokok" class="w-full rounded border px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Uang Makan</label>
          <div class="flex gap-1">
            <input type="number" id="uang_makan" class="flex-1 rounded border px-2 py-1 text-sm" />
            <button type="button" onclick="calcAllowances()" class="text-[10px] bg-accent text-white px-2 rounded">Auto</button>
          </div>
          <p id="uangmakan-info" class="text-[10px] text-slate-500 mt-1"></p>
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Uang Transport</label>
          <input type="number" id="uang_transport" class="w-full rounded border px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Lembur Jam (jumlah jam)</label>
          <input type="number" id="lembur_jam" class="w-full rounded border px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Rate/Jam (Rp)</label>
          <input type="number" id="lembur_jam_rate" value="7000" class="w-full rounded border px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Lembur Libur (jumlah shift)</label>
          <input type="number" id="lembur_libur" class="w-full rounded border px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Rate/Shift (Rp)</label>
          <input type="number" id="lembur_libur_rate" value="35000" class="w-full rounded border px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Tunjangan Jabatan</label>
          <div class="flex gap-1">
            <input type="number" id="tunjangan_jabatan" class="flex-1 rounded border px-2 py-1 text-sm" />
            <button type="button" onclick="calcAllowances()" class="text-[10px] bg-accent text-white px-2 rounded">Auto</button>
          </div>
          <p id="tunjangan-info" class="text-[10px] text-slate-500 mt-1"></p>
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">THR</label>
          <input type="number" id="thr" class="w-full rounded border px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Denda Keterlambatan</label>
          <input type="number" id="denda_terlambat" class="w-full rounded border px-2 py-1 text-sm bg-slate-100" readonly />
          <p id="denda-info" class="text-[10px] text-slate-500 mt-1"></p>
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Denda Lainnya</label>
          <input type="number" id="denda" class="w-full rounded border px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Kasbon</label>
          <input type="number" id="kasbon" class="w-full rounded border px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Komisi Total</label>
          <input type="number" id="komisi_total" class="w-full rounded border px-2 py-1 text-sm bg-slate-100" readonly />
          <button type="button" onclick="calcCommission()" class="text-[10px] text-accent underline mt-1">Hitung dari produksi</button>
        </div>
        
        <div class="col-span-2 md:col-span-3 mt-2">
          <p id="form-status" class="text-xs text-slate-600 mb-2"></p>
          <div class="flex gap-2">
            <button type="submit" class="btn-primary text-sm">Simpan</button>
            <button type="button" onclick="hideForm()" class="btn-secondary text-sm">Batal</button>
          </div>
        </div>
      </form>
    </div>
  </main>

  <script>
    function getToken() { return localStorage.getItem('token'); }
    function formatRupiah(v) { return 'Rp ' + (v || 0).toLocaleString('id-ID'); }
    
    const monthNames = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

    const today = new Date();
    document.getElementById('month').value = today.getMonth() + 1;
    document.getElementById('year').value = today.getFullYear();

    let payrollData = [];
    let outletsData = [];

    async function loadOutlets() {
      const res = await fetch('/api/admin/outlets', {
        headers: { 'Authorization': 'Bearer ' + getToken() }
      });
      outletsData = await res.json();
      const select = document.getElementById('outlet');
      select.innerHTML = '<option value="">Semua Outlet</option>';
      outletsData.forEach(o => {
        select.innerHTML += `<option value="${o.id}">${o.name}</option>`;
      });
    }

    async function loadPayroll() {
      const month = document.getElementById('month').value;
      const year = document.getElementById('year').value;
      
      const res = await fetch(`/api/payroll-v2?month=${month}&year=${year}`, {
        headers: { 'Authorization': 'Bearer ' + getToken() }
      });
      payrollData = await res.json();
      
      const body = document.getElementById('payroll-body');
      body.innerHTML = '';
      payrollData.forEach(p => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="py-2">${p.name}</td>
          <td class="py-2"><span class="px-1 py-0.5 rounded bg-slate-100 text-[10px]">${p.role}</span></td>
          <td class="py-2 text-right">${formatRupiah(p.gaji_pokok)}</td>
          <td class="py-2 text-right text-green-600">${formatRupiah(p.pendapatan)}</td>
          <td class="py-2 text-right text-red-500">${formatRupiah(p.potongan)}</td>
          <td class="py-2 text-right font-semibold">${formatRupiah(p.gaji_bersih)}</td>
          <td class="py-2 text-right space-x-1">
            <button onclick='editPayroll(${JSON.stringify(p)})' class="text-accent underline">Edit</button>
            <button onclick='generateSlipPDF(${JSON.stringify(p)})' class="text-green-600 underline">Slip PDF</button>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    function generateSlipPDF(p) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const month = document.getElementById('month').value;
      const year = document.getElementById('year').value;
      const outletId = document.getElementById('outlet').value;
      const outletName = outletId ? outletsData.find(o => o.id == outletId)?.name : 'Semua Outlet';
      
      // Header
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('SLIP GAJI KARYAWAN', 105, 20, { align: 'center' });
      
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text('NearMe Laundry', 105, 28, { align: 'center' });
      
      // Info
      doc.setFontSize(10);
      let y = 45;
      doc.text(`Tahun       : ${year}`, 20, y);
      doc.text(`Bulan       : ${monthNames[month]}`, 20, y + 7);
      doc.text(`Cabang      : ${outletName}`, 20, y + 14);
      doc.text(`Nama Staff  : ${p.name}`, 20, y + 21);
      
      // Line
      y = 75;
      doc.setLineWidth(0.5);
      doc.line(20, y, 190, y);
      
      // Rincian Gaji
      y = 85;
      doc.setFont('helvetica', 'bold');
      doc.text('RINCIAN GAJI', 20, y);
      
      doc.setFont('helvetica', 'normal');
      y += 10;
      
      const items = [
        ['Gaji Pokok', p.gaji_pokok || 0],
        ['Uang Makan', p.uang_makan || 0],
        ['Uang Transport', p.uang_transport || 0],
        ['Lembur Jam (' + (p.lembur_jam || 0) + ' jam x Rp ' + (p.lembur_jam_rate || 7000).toLocaleString() + ')', p.lembur_jam_total || 0],
        ['Lembur Libur (' + (p.lembur_libur || 0) + ' shift x Rp ' + (p.lembur_libur_rate || 35000).toLocaleString() + ')', p.lembur_libur_total || 0],
        ['Tunjangan Jabatan', p.tunjangan_jabatan || 0],
        ['THR', p.thr || 0],
        ['Komisi', p.komisi_total || 0],
      ];
      
      items.forEach(([label, value]) => {
        if (value > 0) {
          doc.text(label, 25, y);
          doc.text('Rp ' + value.toLocaleString('id-ID'), 180, y, { align: 'right' });
          y += 7;
        }
      });
      
      // Subtotal Pendapatan
      y += 3;
      doc.setFont('helvetica', 'bold');
      doc.text('Total Pendapatan', 25, y);
      doc.text('Rp ' + (p.pendapatan || 0).toLocaleString('id-ID'), 180, y, { align: 'right' });
      
      // Potongan
      y += 15;
      doc.text('POTONGAN', 20, y);
      doc.setFont('helvetica', 'normal');
      y += 10;
      
      const potongan = [
        ['Denda Keterlambatan', p.denda_terlambat || 0],
        ['Denda Lainnya', p.denda || 0],
        ['Kasbon', p.kasbon || 0],
      ];
      
      potongan.forEach(([label, value]) => {
        if (value > 0) {
          doc.text(label, 25, y);
          doc.text('Rp ' + value.toLocaleString('id-ID'), 180, y, { align: 'right' });
          y += 7;
        }
      });
      
      // Total Potongan
      y += 3;
      doc.setFont('helvetica', 'bold');
      doc.text('Total Potongan', 25, y);
      doc.text('Rp ' + (p.potongan || 0).toLocaleString('id-ID'), 180, y, { align: 'right' });
      
      // Line
      y += 10;
      doc.line(20, y, 190, y);
      
      // Gaji Bersih
      y += 10;
      doc.setFontSize(12);
      doc.text('GAJI BERSIH', 25, y);
      doc.text('Rp ' + (p.gaji_bersih || 0).toLocaleString('id-ID'), 180, y, { align: 'right' });
      
      // Footer
      y += 25;
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.text('Slip gaji ini digenerate secara otomatis oleh sistem NearMe Laundry', 105, y, { align: 'center' });
      
      // Save
      const filename = `slip_gaji_${p.name.replace(/\s+/g, '_')}_${monthNames[month]}_${year}.pdf`;
      doc.save(filename);
    }

    function editPayroll(p) {
      document.getElementById('edit-form').classList.remove('hidden');
      document.getElementById('edit-name').textContent = p.name;
      document.getElementById('edit_user_id').value = p.user_id;
      document.getElementById('gaji_pokok').value = p.gaji_pokok || 0;
      document.getElementById('uang_makan').value = p.uang_makan || 0;
      document.getElementById('uang_transport').value = p.uang_transport || 0;
      document.getElementById('lembur_jam').value = p.lembur_jam || 0;
      document.getElementById('lembur_jam_rate').value = p.lembur_jam_rate || 7000;
      document.getElementById('lembur_libur').value = p.lembur_libur || 0;
      document.getElementById('lembur_libur_rate').value = p.lembur_libur_rate || 35000;
      document.getElementById('tunjangan_jabatan').value = p.tunjangan_jabatan || 0;
      document.getElementById('thr').value = p.thr || 0;
      document.getElementById('denda_terlambat').value = p.denda_terlambat || 0;
      document.getElementById('denda').value = p.denda || 0;
      document.getElementById('kasbon').value = p.kasbon || 0;
      document.getElementById('komisi_total').value = p.komisi_total || 0;
      
      // Clear info texts
      document.getElementById('tunjangan-info').textContent = '';
      document.getElementById('uangmakan-info').textContent = '';
      document.getElementById('denda-info').textContent = '';
    }

    function hideForm() {
      document.getElementById('edit-form').classList.add('hidden');
    }

    async function calcAllowances() {
      const user_id = document.getElementById('edit_user_id').value;
      const month = document.getElementById('month').value;
      const year = document.getElementById('year').value;
      
      const statusEl = document.getElementById('form-status');
      statusEl.textContent = 'Menghitung tunjangan...';
      statusEl.className = 'text-xs text-slate-600 mb-2';
      
      try {
        const res = await fetch(`/api/payroll-v2/allowances/${user_id}?month=${month}&year=${year}`, {
          headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        const data = await res.json();
        
        if (!res.ok) {
          statusEl.textContent = data.message || 'Gagal menghitung tunjangan';
          statusEl.className = 'text-xs text-red-500 mb-2';
          return;
        }
        
        // Populate fields
        document.getElementById('tunjangan_jabatan').value = data.tunjangan_jabatan || 0;
        document.getElementById('uang_makan').value = data.uang_makan_total || 0;
        document.getElementById('denda_terlambat').value = data.denda_total || 0;
        
        // Show formula info
        document.getElementById('tunjangan-info').textContent = 
          `Masa kerja: ${data.masa_kerja_bulan} bulan. ${data.tunjangan_jabatan_formula || ''}`;
        document.getElementById('uangmakan-info').textContent = 
          `${data.attendance_count} hari x ${formatRupiah(data.uang_makan_rate)} = ${formatRupiah(data.uang_makan_total)}`;
        document.getElementById('denda-info').textContent = 
          data.late_count > 0 ? `${data.late_count} hari terlambat x ${formatRupiah(data.denda_per_late)} = ${formatRupiah(data.denda_total)}` : 'Tidak ada keterlambatan';
        
        statusEl.textContent = `Tunjangan dihitung otomatis (masa kerja: ${data.masa_kerja_bulan} bulan, kehadiran: ${data.attendance_count} hari, terlambat: ${data.late_count} hari)`;
        statusEl.className = 'text-xs text-green-600 mb-2';
      } catch (err) {
        statusEl.textContent = 'Error: ' + err.message;
        statusEl.className = 'text-xs text-red-500 mb-2';
      }
    }

    async function calcCommission() {
      const user_id = document.getElementById('edit_user_id').value;
      const month = document.getElementById('month').value;
      const year = document.getElementById('year').value;
      
      const res = await fetch(`/api/payroll-v2/commission/${user_id}?month=${month}&year=${year}`, {
        headers: { 'Authorization': 'Bearer ' + getToken() }
      });
      const data = await res.json();
      document.getElementById('komisi_total').value = data.total_komisi || 0;
      document.getElementById('form-status').textContent = 'Komisi dihitung: ' + formatRupiah(data.total_komisi);
    }

    document.getElementById('payroll-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const statusEl = document.getElementById('form-status');
      
      const payload = {
        user_id: Number(document.getElementById('edit_user_id').value),
        month: Number(document.getElementById('month').value),
        year: Number(document.getElementById('year').value),
        gaji_pokok: Number(document.getElementById('gaji_pokok').value) || 0,
        uang_makan: Number(document.getElementById('uang_makan').value) || 0,
        uang_transport: Number(document.getElementById('uang_transport').value) || 0,
        lembur_jam: Number(document.getElementById('lembur_jam').value) || 0,
        lembur_jam_rate: Number(document.getElementById('lembur_jam_rate').value) || 7000,
        lembur_libur: Number(document.getElementById('lembur_libur').value) || 0,
        lembur_libur_rate: Number(document.getElementById('lembur_libur_rate').value) || 35000,
        tunjangan_jabatan: Number(document.getElementById('tunjangan_jabatan').value) || 0,
        thr: Number(document.getElementById('thr').value) || 0,
        denda_terlambat: Number(document.getElementById('denda_terlambat').value) || 0,
        denda: Number(document.getElementById('denda').value) || 0,
        kasbon: Number(document.getElementById('kasbon').value) || 0,
        komisi_total: Number(document.getElementById('komisi_total').value) || 0
      };
      
      const res = await fetch('/api/payroll-v2', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getToken() },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      statusEl.textContent = data.message;
      statusEl.className = res.ok ? 'text-xs text-green-600 mb-2' : 'text-xs text-red-500 mb-2';
      if (res.ok) {
        loadPayroll();
      }
    });

    loadOutlets();
    loadPayroll();
  </script>
</body>
</html>
