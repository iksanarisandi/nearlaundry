<!-- nav-v2 -->
<!doctype html>
<html lang="id" class="h-full">
<head>
  <link rel="icon" type="image/png" href="/icon.png" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Payroll - NearMe Laundry</title>
  <link rel="stylesheet" href="/styles.css" />
  <script src="/shared/nav.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body class="min-h-full flex flex-col bg-slate-100" onload="NearMeNav.ensureRole(['admin'])">
  <header class="bg-white shadow-sm">
    <div class="mx-auto max-w-5xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="/icon.png" alt="Logo" class="h-8 w-8 rounded-full object-cover" />
        <div>
          <div class="font-semibold text-primary text-sm">NearMe Laundry - Admin</div>
          <div class="text-[11px] text-slate-500">Payroll Karyawan</div>
        </div>
      </div>
      <nav class="flex items-center gap-3 text-[11px] text-slate-600"></nav>
      <script>document.addEventListener('DOMContentLoaded', () => NearMeNav.renderAdminNav('payroll'));</script>
    </div>
  </header>

  <main class="flex-1 mx-auto w-full max-w-5xl px-4 py-4">
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3 mb-4">
      <div>
        <h1 class="text-lg font-semibold">Payroll Karyawan</h1>
        <p class="text-xs text-slate-500">Atur gaji, lembur, tunjangan, dan potongan.</p>
      </div>
      <div class="flex items-center gap-2 text-xs">
        <select id="outlet" class="rounded-lg border px-2 py-1">
          <option value="">Semua Outlet</option>
        </select>
        <select id="month" class="rounded-lg border px-2 py-1">
          <option value="1">Januari</option><option value="2">Februari</option>
          <option value="3">Maret</option><option value="4">April</option>
          <option value="5">Mei</option><option value="6">Juni</option>
          <option value="7">Juli</option><option value="8">Agustus</option>
          <option value="9">September</option><option value="10">Oktober</option>
          <option value="11">November</option><option value="12">Desember</option>
        </select>
        <input type="number" id="year" class="w-20 rounded-lg border px-2 py-1" />
        <button onclick="loadPayroll()" class="btn-secondary py-1">Tampilkan</button>
      </div>
    </div>

    <!-- Daftar Karyawan -->
    <div class="card mb-4">
      <h2 class="text-sm font-semibold mb-3">Daftar Karyawan</h2>
      <div class="overflow-x-auto">
        <table class="w-full text-xs">
          <thead>
            <tr class="text-left text-slate-500 border-b">
              <th class="py-2">Nama</th>
              <th class="py-2">Role</th>
              <th class="py-2 text-right">Gaji Pokok</th>
              <th class="py-2 text-right">Pendapatan</th>
              <th class="py-2 text-right">Potongan</th>
              <th class="py-2 text-right">Gaji Bersih</th>
              <th class="py-2 text-right">Aksi</th>
            </tr>
          </thead>
          <tbody id="payroll-body" class="divide-y"></tbody>
        </table>
      </div>
    </div>

    <!-- Slip Preview Modal -->
    <div id="slip-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
      <div class="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-4 border-b flex items-center justify-between">
          <h3 class="font-semibold text-sm">Preview Slip Gaji</h3>
          <button onclick="closeSlipModal()" class="text-slate-400 hover:text-slate-600">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div id="slip-preview-container" class="p-4 flex justify-center">
          <!-- Slip HTML will be rendered here -->
        </div>
        <div class="p-4 border-t flex gap-2 justify-end">
          <button onclick="downloadSlipImage()" class="btn-secondary text-sm flex items-center gap-1">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            Download Gambar
          </button>
          <button id="btn-open-wa" onclick="openWhatsApp()" class="btn-primary text-sm flex items-center gap-1">
            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
            </svg>
            Buka WhatsApp
          </button>
          <button onclick="closeSlipModal()" class="btn-secondary text-sm">Tutup</button>
        </div>
        <p id="slip-error" class="px-4 pb-4 text-xs text-red-500 hidden"></p>
      </div>
    </div>

    <!-- Form Edit Payroll -->
    <div id="edit-form" class="card hidden">
      <h2 class="text-sm font-semibold mb-3">Edit Payroll: <span id="edit-name"></span></h2>
      <form id="payroll-form" class="grid grid-cols-2 md:grid-cols-3 gap-3">
        <input type="hidden" id="edit_user_id" />
        
        <div>
          <label class="block text-xs text-slate-600 mb-1">Gaji Pokok</label>
          <input type="number" id="gaji_pokok" class="w-full rounded border px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Uang Makan</label>
          <div class="flex gap-1">
            <input type="number" id="uang_makan" class="flex-1 rounded border px-2 py-1 text-sm" />
            <button type="button" onclick="calcAllowances()" class="text-[10px] bg-accent text-white px-2 rounded">Auto</button>
          </div>
          <p id="uangmakan-info" class="text-[10px] text-slate-500 mt-1"></p>
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Uang Transport</label>
          <div class="flex gap-1">
            <input type="number" id="uang_transport" class="flex-1 rounded border px-2 py-1 text-sm" />
            <button type="button" onclick="calcAllowances()" class="text-[10px] bg-accent text-white px-2 rounded">Auto</button>
          </div>
          <p id="transport-info" class="text-[10px] text-slate-500 mt-1"></p>
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Lembur Jam (jumlah jam)</label>
          <div class="flex gap-1">
            <input type="number" id="lembur_jam" class="flex-1 rounded border px-2 py-1 text-sm" />
            <button type="button" onclick="calcAllowances()" class="text-[10px] bg-accent text-white px-2 rounded">Auto</button>
          </div>
          <p id="lembur-info" class="text-[10px] text-slate-500 mt-1"></p>
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Rate/Jam (Rp)</label>
          <input type="number" id="lembur_jam_rate" value="7000" class="w-full rounded border px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Lembur Libur (jumlah shift)</label>
          <input type="number" id="lembur_libur" class="w-full rounded border px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Rate/Shift (Rp)</label>
          <input type="number" id="lembur_libur_rate" value="35000" class="w-full rounded border px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Tunjangan Jabatan</label>
          <div class="flex gap-1">
            <input type="number" id="tunjangan_jabatan" class="flex-1 rounded border px-2 py-1 text-sm" />
            <button type="button" onclick="calcAllowances()" class="text-[10px] bg-accent text-white px-2 rounded">Auto</button>
          </div>
          <p id="tunjangan-info" class="text-[10px] text-slate-500 mt-1"></p>
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">THR</label>
          <input type="number" id="thr" class="w-full rounded border px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Denda Keterlambatan</label>
          <input type="number" id="denda_terlambat" class="w-full rounded border px-2 py-1 text-sm bg-slate-100" readonly />
          <p id="denda-info" class="text-[10px] text-slate-500 mt-1"></p>
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Denda Lainnya</label>
          <input type="number" id="denda" class="w-full rounded border px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Kasbon</label>
          <input type="number" id="kasbon" class="w-full rounded border px-2 py-1 text-sm" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Komisi Total</label>
          <input type="number" id="komisi_total" class="w-full rounded border px-2 py-1 text-sm bg-slate-100" readonly />
          <button type="button" onclick="calcCommission()" class="text-[10px] text-accent underline mt-1">Hitung dari produksi</button>
        </div>
        
        <div class="col-span-2 md:col-span-3 mt-2">
          <p id="form-status" class="text-xs text-slate-600 mb-2"></p>
          <div class="flex gap-2">
            <button type="submit" class="btn-primary text-sm">Simpan</button>
            <button type="button" onclick="hideForm()" class="btn-secondary text-sm">Batal</button>
          </div>
        </div>
      </form>
    </div>
  </main>

  <script>
    function getToken() { return localStorage.getItem('token'); }
    function formatRupiah(v) { return 'Rp ' + (v || 0).toLocaleString('id-ID'); }
    
    const monthNames = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
                        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];

    const today = new Date();
    document.getElementById('month').value = today.getMonth() + 1;
    document.getElementById('year').value = today.getFullYear();

    let payrollData = [];
    let outletsData = [];

    async function loadOutlets() {
      const res = await fetch('/api/admin/outlets', {
        headers: { 'Authorization': 'Bearer ' + getToken() }
      });
      outletsData = await res.json();
      const select = document.getElementById('outlet');
      select.innerHTML = '<option value="">Semua Outlet</option>';
      outletsData.forEach(o => {
        select.innerHTML += `<option value="${o.id}">${o.name}</option>`;
      });
    }

    async function loadPayroll() {
      const month = document.getElementById('month').value;
      const year = document.getElementById('year').value;
      
      const res = await fetch(`/api/payroll-v2?month=${month}&year=${year}`, {
        headers: { 'Authorization': 'Bearer ' + getToken() }
      });
      payrollData = await res.json();
      
      const body = document.getElementById('payroll-body');
      body.innerHTML = '';
      payrollData.forEach(p => {
        const tr = document.createElement('tr');
        const pJson = JSON.stringify(p).replace(/'/g, "\\'");
        tr.innerHTML = `
          <td class="py-2">${p.name}</td>
          <td class="py-2"><span class="px-1 py-0.5 rounded bg-slate-100 text-[10px]">${p.role}</span></td>
          <td class="py-2 text-right">${formatRupiah(p.gaji_pokok)}</td>
          <td class="py-2 text-right text-green-600">${formatRupiah(p.pendapatan)}</td>
          <td class="py-2 text-right text-red-500">${formatRupiah(p.potongan)}</td>
          <td class="py-2 text-right font-semibold">${formatRupiah(p.gaji_bersih)}</td>
          <td class="py-2 text-right space-x-1">
            <button onclick='editPayroll(${pJson})' class="text-accent underline">Edit</button>
            <button onclick='generateSlipPDF(${pJson})' class="text-green-600 underline">Slip PDF</button>
            <button onclick='sendToWhatsApp(${pJson})' class="text-emerald-600 underline">Slip PNG</button>
          </td>
        `;
        body.appendChild(tr);
      });
    }

    function generateSlipPDF(p) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const month = document.getElementById('month').value;
      const year = document.getElementById('year').value;
      const outletId = document.getElementById('outlet').value;
      const outletName = outletId ? outletsData.find(o => o.id == outletId)?.name : 'Semua Outlet';
      
      // Header
      doc.setFontSize(16);
      doc.setFont('helvetica', 'bold');
      doc.text('SLIP GAJI KARYAWAN', 105, 20, { align: 'center' });
      
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text('NearMe Laundry', 105, 28, { align: 'center' });
      
      // Info
      doc.setFontSize(10);
      let y = 45;
      doc.text(`Tahun       : ${year}`, 20, y);
      doc.text(`Bulan       : ${monthNames[month]}`, 20, y + 7);
      doc.text(`Cabang      : ${outletName}`, 20, y + 14);
      doc.text(`Nama Staff  : ${p.name}`, 20, y + 21);
      
      // Line
      y = 75;
      doc.setLineWidth(0.5);
      doc.line(20, y, 190, y);
      
      // Rincian Gaji
      y = 85;
      doc.setFont('helvetica', 'bold');
      doc.text('RINCIAN GAJI', 20, y);
      
      doc.setFont('helvetica', 'normal');
      y += 10;
      
      const items = [
        ['Gaji Pokok', p.gaji_pokok || 0],
        ['Uang Makan', p.uang_makan || 0],
        ['Uang Transport', p.uang_transport || 0],
        ['Lembur Jam (' + (p.lembur_jam || 0) + ' jam x Rp ' + (p.lembur_jam_rate || 7000).toLocaleString() + ')', p.lembur_jam_total || 0],
        ['Lembur Libur (' + (p.lembur_libur || 0) + ' shift x Rp ' + (p.lembur_libur_rate || 35000).toLocaleString() + ')', p.lembur_libur_total || 0],
        ['Tunjangan Jabatan', p.tunjangan_jabatan || 0],
        ['THR', p.thr || 0],
        ['Komisi', p.komisi_total || 0],
      ];
      
      items.forEach(([label, value]) => {
        if (value > 0) {
          doc.text(label, 25, y);
          doc.text('Rp ' + value.toLocaleString('id-ID'), 180, y, { align: 'right' });
          y += 7;
        }
      });
      
      // Subtotal Pendapatan
      y += 3;
      doc.setFont('helvetica', 'bold');
      doc.text('Total Pendapatan', 25, y);
      doc.text('Rp ' + (p.pendapatan || 0).toLocaleString('id-ID'), 180, y, { align: 'right' });
      
      // Potongan
      y += 15;
      doc.text('POTONGAN', 20, y);
      doc.setFont('helvetica', 'normal');
      y += 10;
      
      const potongan = [
        ['Denda Keterlambatan', p.denda_terlambat || 0],
        ['Denda Lainnya', p.denda || 0],
        ['Kasbon', p.kasbon || 0],
      ];
      
      potongan.forEach(([label, value]) => {
        if (value > 0) {
          doc.text(label, 25, y);
          doc.text('Rp ' + value.toLocaleString('id-ID'), 180, y, { align: 'right' });
          y += 7;
        }
      });
      
      // Total Potongan
      y += 3;
      doc.setFont('helvetica', 'bold');
      doc.text('Total Potongan', 25, y);
      doc.text('Rp ' + (p.potongan || 0).toLocaleString('id-ID'), 180, y, { align: 'right' });
      
      // Line
      y += 10;
      doc.line(20, y, 190, y);
      
      // Gaji Bersih
      y += 10;
      doc.setFontSize(12);
      doc.text('GAJI BERSIH', 25, y);
      doc.text('Rp ' + (p.gaji_bersih || 0).toLocaleString('id-ID'), 180, y, { align: 'right' });
      
      // Footer
      y += 25;
      doc.setFontSize(8);
      doc.setFont('helvetica', 'normal');
      doc.text('Slip gaji ini digenerate secara otomatis oleh sistem NearMe Laundry', 105, y, { align: 'center' });
      
      // Save
      const filename = `slip_gaji_${p.name.replace(/\s+/g, '_')}_${monthNames[month]}_${year}.pdf`;
      doc.save(filename);
    }

    function editPayroll(p) {
      document.getElementById('edit-form').classList.remove('hidden');
      document.getElementById('edit-name').textContent = p.name;
      document.getElementById('edit_user_id').value = p.user_id;
      document.getElementById('gaji_pokok').value = p.gaji_pokok || 0;
      document.getElementById('uang_makan').value = p.uang_makan || 0;
      document.getElementById('uang_transport').value = p.uang_transport || 0;
      document.getElementById('lembur_jam').value = p.lembur_jam || 0;
      document.getElementById('lembur_jam_rate').value = p.lembur_jam_rate || 7000;
      document.getElementById('lembur_libur').value = p.lembur_libur || 0;
      document.getElementById('lembur_libur_rate').value = p.lembur_libur_rate || 35000;
      document.getElementById('tunjangan_jabatan').value = p.tunjangan_jabatan || 0;
      document.getElementById('thr').value = p.thr || 0;
      document.getElementById('denda_terlambat').value = p.denda_terlambat || 0;
      document.getElementById('denda').value = p.denda || 0;
      document.getElementById('kasbon').value = p.kasbon || 0;
      document.getElementById('komisi_total').value = p.komisi_total || 0;
      
      // Clear info texts
      document.getElementById('tunjangan-info').textContent = '';
      document.getElementById('uangmakan-info').textContent = '';
      document.getElementById('transport-info').textContent = '';
      document.getElementById('lembur-info').textContent = '';
      document.getElementById('denda-info').textContent = '';
    }

    function hideForm() {
      document.getElementById('edit-form').classList.add('hidden');
    }

    async function calcAllowances() {
      const user_id = document.getElementById('edit_user_id').value;
      const month = document.getElementById('month').value;
      const year = document.getElementById('year').value;
      
      const statusEl = document.getElementById('form-status');
      statusEl.textContent = 'Menghitung tunjangan...';
      statusEl.className = 'text-xs text-slate-600 mb-2';
      
      try {
        const res = await fetch(`/api/payroll-v2/allowances/${user_id}?month=${month}&year=${year}`, {
          headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        const data = await res.json();
        
        if (!res.ok) {
          statusEl.textContent = data.message || 'Gagal menghitung tunjangan';
          statusEl.className = 'text-xs text-red-500 mb-2';
          return;
        }
        
        // Populate fields
        document.getElementById('tunjangan_jabatan').value = data.tunjangan_jabatan || 0;
        document.getElementById('uang_makan').value = data.uang_makan_total || 0;
        document.getElementById('uang_transport').value = data.uang_transport_total || 0;
        document.getElementById('lembur_jam').value = data.lembur_jam || 0;
        document.getElementById('denda_terlambat').value = data.denda_total || 0;
        
        // Show formula info
        document.getElementById('tunjangan-info').textContent = 
          `Masa kerja: ${data.masa_kerja_bulan} bulan. ${data.tunjangan_jabatan_formula || ''}`;
        document.getElementById('uangmakan-info').textContent = 
          `${data.attendance_count} hari x ${formatRupiah(data.uang_makan_rate)} = ${formatRupiah(data.uang_makan_total)}`;
        document.getElementById('transport-info').textContent = 
          `${data.attendance_count} hari x ${formatRupiah(data.uang_transport_rate)} = ${formatRupiah(data.uang_transport_total)}`;
        document.getElementById('lembur-info').textContent = 
          data.lembur_jam > 0 ? `${data.lembur_jam} jam x ${formatRupiah(data.lembur_rate)} = ${formatRupiah(data.lembur_total)}` : 'Tidak ada lembur (< 3 jam/hari)';
        document.getElementById('denda-info').textContent = 
          data.late_count > 0 ? `${data.late_count} hari terlambat x ${formatRupiah(data.denda_per_late)} = ${formatRupiah(data.denda_total)}` : 'Tidak ada keterlambatan';
        
        statusEl.textContent = `Dihitung otomatis: kehadiran ${data.attendance_count} hari, lembur ${data.lembur_jam} jam, terlambat ${data.late_count} hari`;
        statusEl.className = 'text-xs text-green-600 mb-2';
      } catch (err) {
        statusEl.textContent = 'Error: ' + err.message;
        statusEl.className = 'text-xs text-red-500 mb-2';
      }
    }

    async function calcCommission() {
      const user_id = document.getElementById('edit_user_id').value;
      const month = document.getElementById('month').value;
      const year = document.getElementById('year').value;
      
      const res = await fetch(`/api/payroll-v2/commission/${user_id}?month=${month}&year=${year}`, {
        headers: { 'Authorization': 'Bearer ' + getToken() }
      });
      const data = await res.json();
      document.getElementById('komisi_total').value = data.total_komisi || 0;
      document.getElementById('form-status').textContent = 'Komisi dihitung: ' + formatRupiah(data.total_komisi);
    }

    document.getElementById('payroll-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const statusEl = document.getElementById('form-status');
      
      const payload = {
        user_id: Number(document.getElementById('edit_user_id').value),
        month: Number(document.getElementById('month').value),
        year: Number(document.getElementById('year').value),
        gaji_pokok: Number(document.getElementById('gaji_pokok').value) || 0,
        uang_makan: Number(document.getElementById('uang_makan').value) || 0,
        uang_transport: Number(document.getElementById('uang_transport').value) || 0,
        lembur_jam: Number(document.getElementById('lembur_jam').value) || 0,
        lembur_jam_rate: Number(document.getElementById('lembur_jam_rate').value) || 7000,
        lembur_libur: Number(document.getElementById('lembur_libur').value) || 0,
        lembur_libur_rate: Number(document.getElementById('lembur_libur_rate').value) || 35000,
        tunjangan_jabatan: Number(document.getElementById('tunjangan_jabatan').value) || 0,
        thr: Number(document.getElementById('thr').value) || 0,
        denda_terlambat: Number(document.getElementById('denda_terlambat').value) || 0,
        denda: Number(document.getElementById('denda').value) || 0,
        kasbon: Number(document.getElementById('kasbon').value) || 0,
        komisi_total: Number(document.getElementById('komisi_total').value) || 0
      };
      
      const res = await fetch('/api/payroll-v2', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + getToken() },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      statusEl.textContent = data.message;
      statusEl.className = res.ok ? 'text-xs text-green-600 mb-2' : 'text-xs text-red-500 mb-2';
      if (res.ok) {
        loadPayroll();
      }
    });

    // ============================================
    // WhatsApp Slip Functions
    // Feature: payroll-slip-whatsapp
    // Requirements: 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4
    // ============================================
    
    let currentSlipData = null;
    
    /**
     * Sanitize name for filename
     */
    function sanitizeName(name) {
      return name.trim().replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
    }
    
    /**
     * Generate slip filename
     * Requirements: 2.3
     */
    function generateSlipFilename(name, month, year) {
      const sanitizedName = sanitizeName(name);
      const monthName = monthNames[month] || '';
      return `slip_gaji_${sanitizedName}_${monthName}_${year}.png`;
    }
    
    /**
     * Generate WhatsApp link with pre-filled message
     * Requirements: 3.2, 3.3
     */
    function generateWhatsAppLink(phone, name, period) {
      const message = `Halo ${name}, berikut slip gaji Anda untuk periode ${period}. Silakan cek lampiran gambar.`;
      const encodedMessage = encodeURIComponent(message);
      return `https://wa.me/${phone}?text=${encodedMessage}`;
    }
    
    /**
     * Generate slip HTML for rendering
     * Requirements: 4.2
     */
    function generateSlipHTML(data) {
      const monthName = monthNames[data.month] || '';
      const period = `${monthName} ${data.year}`;
      
      const lemburJamTotal = (data.lembur_jam || 0) * (data.lembur_jam_rate || 7000);
      const lemburLiburTotal = (data.lembur_libur || 0) * (data.lembur_libur_rate || 35000);
      
      // Build income items
      const incomeItems = [];
      if (data.gaji_pokok > 0) incomeItems.push({ label: 'Gaji Pokok', value: data.gaji_pokok });
      if (data.uang_makan > 0) incomeItems.push({ label: 'Uang Makan', value: data.uang_makan });
      if (data.uang_transport > 0) incomeItems.push({ label: 'Uang Transport', value: data.uang_transport });
      if (lemburJamTotal > 0) incomeItems.push({ 
        label: `Lembur Jam (${data.lembur_jam} jam x ${formatRupiah(data.lembur_jam_rate || 7000)})`, 
        value: lemburJamTotal 
      });
      if (lemburLiburTotal > 0) incomeItems.push({ 
        label: `Lembur Libur (${data.lembur_libur} shift x ${formatRupiah(data.lembur_libur_rate || 35000)})`, 
        value: lemburLiburTotal 
      });
      if (data.tunjangan_jabatan > 0) incomeItems.push({ label: 'Tunjangan Jabatan', value: data.tunjangan_jabatan });
      if (data.thr > 0) incomeItems.push({ label: 'THR', value: data.thr });
      if (data.komisi_total > 0) incomeItems.push({ label: 'Komisi', value: data.komisi_total });
      
      // Build deduction items
      const deductionItems = [];
      if (data.denda_terlambat > 0) deductionItems.push({ label: 'Denda Keterlambatan', value: data.denda_terlambat });
      if (data.denda > 0) deductionItems.push({ label: 'Denda Lainnya', value: data.denda });
      if (data.kasbon > 0) deductionItems.push({ label: 'Kasbon', value: data.kasbon });
      
      const incomeRowsHTML = incomeItems.map(item => `
        <tr>
          <td style="padding: 4px 8px; font-size: 12px;">${item.label}</td>
          <td style="padding: 4px 8px; font-size: 12px; text-align: right;">${formatRupiah(item.value)}</td>
        </tr>
      `).join('');
      
      const deductionRowsHTML = deductionItems.map(item => `
        <tr>
          <td style="padding: 4px 8px; font-size: 12px;">${item.label}</td>
          <td style="padding: 4px 8px; font-size: 12px; text-align: right;">${formatRupiah(item.value)}</td>
        </tr>
      `).join('');

      return `
<div id="slip-content" style="width: 400px; padding: 20px; background: white; font-family: Arial, sans-serif; border: 1px solid #ddd;">
  <div style="text-align: center; margin-bottom: 16px; border-bottom: 2px solid #333; padding-bottom: 12px;">
    <h1 style="margin: 0; font-size: 18px; font-weight: bold;">SLIP GAJI KARYAWAN</h1>
    <p style="margin: 4px 0 0 0; font-size: 14px; color: #666;">NearMe Laundry</p>
  </div>
  
  <div style="margin-bottom: 16px; font-size: 12px;">
    <table style="width: 100%;">
      <tr>
        <td style="padding: 2px 0; width: 100px;">Nama</td>
        <td style="padding: 2px 0;">: <strong>${data.name}</strong></td>
      </tr>
      <tr>
        <td style="padding: 2px 0;">Periode</td>
        <td style="padding: 2px 0;">: ${period}</td>
      </tr>
      <tr>
        <td style="padding: 2px 0;">Cabang</td>
        <td style="padding: 2px 0;">: ${data.outletName}</td>
      </tr>
    </table>
  </div>
  
  <div style="margin-bottom: 12px;">
    <div style="background: #f0f9f0; padding: 6px 8px; font-weight: bold; font-size: 13px; border-left: 3px solid #22c55e;">
      PENDAPATAN
    </div>
    <table style="width: 100%; border-collapse: collapse;">
      ${incomeRowsHTML}
      <tr style="border-top: 1px solid #ddd; font-weight: bold;">
        <td style="padding: 6px 8px; font-size: 12px;">Total Pendapatan</td>
        <td style="padding: 6px 8px; font-size: 12px; text-align: right; color: #22c55e;">${formatRupiah(data.pendapatan)}</td>
      </tr>
    </table>
  </div>
  
  <div style="margin-bottom: 12px;">
    <div style="background: #fef2f2; padding: 6px 8px; font-weight: bold; font-size: 13px; border-left: 3px solid #ef4444;">
      POTONGAN
    </div>
    <table style="width: 100%; border-collapse: collapse;">
      ${deductionRowsHTML.length > 0 ? deductionRowsHTML : '<tr><td style="padding: 4px 8px; font-size: 12px; color: #999;">Tidak ada potongan</td></tr>'}
      <tr style="border-top: 1px solid #ddd; font-weight: bold;">
        <td style="padding: 6px 8px; font-size: 12px;">Total Potongan</td>
        <td style="padding: 6px 8px; font-size: 12px; text-align: right; color: #ef4444;">${formatRupiah(data.potongan)}</td>
      </tr>
    </table>
  </div>
  
  <div style="background: #1e40af; color: white; padding: 12px; text-align: center; margin-top: 16px;">
    <div style="font-size: 12px; margin-bottom: 4px;">GAJI BERSIH</div>
    <div style="font-size: 20px; font-weight: bold;">${formatRupiah(data.gaji_bersih)}</div>
  </div>
  
  <div style="margin-top: 12px; text-align: center; font-size: 10px; color: #999;">
    Slip gaji ini digenerate secara otomatis oleh sistem NearMe Laundry
  </div>
</div>
      `.trim();
    }
    
    /**
     * Send payroll slip to WhatsApp
     * Requirements: 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3, 3.4
     */
    async function sendToWhatsApp(payrollData) {
      const month = document.getElementById('month').value;
      const year = document.getElementById('year').value;
      const outletId = document.getElementById('outlet').value;
      const outletName = outletId ? outletsData.find(o => o.id == outletId)?.name : 'Semua Outlet';
      
      // Prepare slip data
      currentSlipData = {
        ...payrollData,
        month: parseInt(month),
        year: parseInt(year),
        outletName: outletName
      };
      
      // Show modal
      const modal = document.getElementById('slip-modal');
      const previewContainer = document.getElementById('slip-preview-container');
      const errorEl = document.getElementById('slip-error');
      const waButton = document.getElementById('btn-open-wa');
      
      // Generate and render slip HTML
      const slipHTML = generateSlipHTML(currentSlipData);
      previewContainer.innerHTML = slipHTML;
      
      // Handle phone number availability
      if (!currentSlipData.phone) {
        waButton.disabled = true;
        waButton.classList.add('opacity-50', 'cursor-not-allowed');
        errorEl.textContent = 'Nomor telepon karyawan belum diisi. Silakan update data karyawan terlebih dahulu.';
        errorEl.classList.remove('hidden');
      } else {
        waButton.disabled = false;
        waButton.classList.remove('opacity-50', 'cursor-not-allowed');
        errorEl.classList.add('hidden');
      }
      
      modal.classList.remove('hidden');
      
      // Auto-download image
      await downloadSlipImage();
    }
    
    /**
     * Download slip as PNG image
     * Requirements: 2.2, 2.3
     */
    async function downloadSlipImage() {
      const slipContent = document.getElementById('slip-content');
      if (!slipContent || !currentSlipData) return;
      
      try {
        const canvas = await html2canvas(slipContent, {
          scale: 2,
          backgroundColor: '#ffffff',
          useCORS: true
        });
        
        const link = document.createElement('a');
        link.download = generateSlipFilename(currentSlipData.name, currentSlipData.month, currentSlipData.year);
        link.href = canvas.toDataURL('image/png');
        link.click();
      } catch (err) {
        console.error('Error generating slip image:', err);
        const errorEl = document.getElementById('slip-error');
        errorEl.textContent = 'Gagal membuat gambar slip. Silakan coba lagi.';
        errorEl.classList.remove('hidden');
      }
    }
    
    /**
     * Open WhatsApp with pre-filled message
     * Requirements: 3.1, 3.2, 3.3, 3.4
     */
    function openWhatsApp() {
      if (!currentSlipData || !currentSlipData.phone) {
        const errorEl = document.getElementById('slip-error');
        errorEl.textContent = 'Nomor telepon karyawan belum diisi.';
        errorEl.classList.remove('hidden');
        return;
      }
      
      const monthName = monthNames[currentSlipData.month] || '';
      const period = `${monthName} ${currentSlipData.year}`;
      const waLink = generateWhatsAppLink(currentSlipData.phone, currentSlipData.name, period);
      
      window.open(waLink, '_blank');
    }
    
    /**
     * Close slip preview modal
     */
    function closeSlipModal() {
      document.getElementById('slip-modal').classList.add('hidden');
      currentSlipData = null;
    }

    loadOutlets();
    loadPayroll();
  </script>
</body>
</html>

