<!-- nav-v2 -->
<!doctype html>
<html lang="id" class="h-full">
<head>
  <link rel="icon" type="image/png" href="/icon.png" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Audit Produksi - NearMe Laundry</title>
  <link rel="stylesheet" href="/styles.css" />
  <script src="/shared/nav.js" defer></script>
  <script src="/shared/currency.js" defer></script>
</head>
<body class="min-h-full flex flex-col bg-slate-100" onload="NearMeNav.ensureRole(['admin'])">
  <header class="bg-white shadow-sm">
    <div class="mx-auto max-w-5xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="/icon.png" alt="Logo NearMe Laundry" class="h-8 w-8 rounded-full object-cover" />
        <div>
          <div class="font-semibold text-primary text-sm">NearMe Laundry - Admin</div>
          <div class="text-[11px] text-slate-500">Mini ERP Laundry Harian</div>
        </div>
      </div>
      <nav class="flex items-center gap-3 text-[11px] text-slate-600"></nav>
      <script>document.addEventListener('DOMContentLoaded', () => NearMeNav.renderAdminNav('audit-produksi'));</script>
    </div>
  </header>

  <main class="flex-1 mx-auto w-full max-w-5xl px-4 py-4">
    <div class="mb-4">
      <h1 class="text-lg font-semibold">Audit Produksi Bulanan</h1>
      <p class="text-xs text-slate-500">Verifikasi dan audit data produksi sebelum penggajian.</p>
    </div>

    <!-- Filter Form -->
    <div class="card mb-4">
      <div class="flex flex-wrap items-end gap-3">
        <div>
          <label class="block text-xs text-slate-600 mb-1">Bulan</label>
          <input type="month" id="filter-month" class="rounded-lg border border-slate-200 px-2 py-1 text-xs" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Outlet</label>
          <select id="filter-outlet" class="rounded-lg border border-slate-200 px-2 py-1 text-xs min-w-[120px]">
            <option value="">Semua Outlet</option>
          </select>
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Staff</label>
          <select id="filter-user" class="rounded-lg border border-slate-200 px-2 py-1 text-xs min-w-[120px]">
            <option value="">Semua Staff</option>
          </select>
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Status</label>
          <select id="filter-verified" class="rounded-lg border border-slate-200 px-2 py-1 text-xs">
            <option value="all">Semua</option>
            <option value="false">Belum Verifikasi</option>
            <option value="true">Terverifikasi</option>
          </select>
        </div>
        <button id="btn-load" class="btn-primary text-xs">Terapkan</button>
        <button id="btn-export" class="btn-secondary text-xs">Export CSV</button>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4">
      <div class="card text-center">
        <div class="text-2xl font-bold text-primary" id="sum-weight">0</div>
        <div class="text-xs text-slate-500">Total Berat (kg)</div>
      </div>
      <div class="card text-center">
        <div class="text-2xl font-bold text-primary" id="sum-qty">0</div>
        <div class="text-xs text-slate-500">Total Qty</div>
      </div>
      <div class="card text-center">
        <div class="text-2xl font-bold text-green-600" id="sum-verified">0</div>
        <div class="text-xs text-slate-500">Nota Terverifikasi</div>
      </div>
      <div class="card text-center">
        <div class="text-2xl font-bold text-orange-500" id="sum-unverified">0</div>
        <div class="text-xs text-slate-500">Belum Verifikasi</div>
      </div>
    </div>

    <!-- Progress Bar -->
    <div class="card mb-4">
      <div class="flex items-center justify-between text-xs mb-1">
        <span class="text-slate-600">Progress Verifikasi</span>
        <span id="progress-text" class="font-medium">0%</span>
      </div>
      <div class="w-full bg-slate-200 rounded-full h-2">
        <div id="progress-bar" class="bg-green-500 h-2 rounded-full transition-all" style="width: 0%"></div>
      </div>
    </div>

    <!-- Data Table -->
    <div class="card">
      <div class="overflow-x-auto">
        <table class="w-full text-xs">
          <thead>
            <tr class="text-left text-slate-500 border-b">
              <th class="py-2 px-1">Nota</th>
              <th class="py-2 px-1">Pelanggan</th>
              <th class="py-2 px-1">Staff</th>
              <th class="py-2 px-1">Outlet</th>
              <th class="py-2 px-1">Proses</th>
              <th class="py-2 px-1 text-right">Qty</th>
              <th class="py-2 px-1 text-right">Berat</th>
              <th class="py-2 px-1 text-right">Harga Jasa</th>
              <th class="py-2 px-1">Waktu</th>
              <th class="py-2 px-1">Status</th>
              <th class="py-2 px-1">Aksi</th>
            </tr>
          </thead>
          <tbody id="data-body" class="divide-y"></tbody>
        </table>
      </div>
      <p id="status" class="text-xs text-slate-600 mt-3"></p>
    </div>
  </main>

  <!-- Modal Edit -->
  <div id="modal-edit" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div id="edit-backdrop" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; padding: 16px;">
      <div style="background: white; border-radius: 8px; padding: 20px; width: 100%; max-width: 400px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <h3 class="text-base font-semibold mb-3">Edit Data Produksi</h3>
      <form id="edit-form" class="space-y-3">
        <input type="hidden" id="edit-id" />
        <div>
          <label class="block text-xs text-slate-600 mb-1">Nama Pelanggan</label>
          <input type="text" id="edit-customer" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-xs" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Nomor Nota</label>
          <input type="text" id="edit-nota" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-xs" />
        </div>
        <div>
          <label class="block text-xs text-slate-600 mb-1">Proses</label>
          <select id="edit-process" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-xs">
            <option value="cuci">Cuci</option>
            <option value="kering">Kering</option>
            <option value="setrika">Setrika</option>
            <option value="packing">Packing</option>
            <option value="cuci_sepatu">Cuci Sepatu</option>
            <option value="cuci_satuan">Cuci Satuan</option>
          </select>
        </div>
        <div class="grid grid-cols-3 gap-2">
          <div>
            <label class="block text-xs text-slate-600 mb-1">Qty</label>
            <input type="number" id="edit-qty" min="1" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-xs" />
          </div>
          <div>
            <label class="block text-xs text-slate-600 mb-1">Berat (kg)</label>
            <input type="number" id="edit-weight" min="0" step="0.1" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-xs" />
          </div>
          <div>
            <label class="block text-xs text-slate-600 mb-1">Harga Jasa</label>
            <input type="number" id="edit-price" min="0" class="w-full rounded-lg border border-slate-200 px-3 py-2 text-xs" />
          </div>
        </div>
        <p id="edit-error" class="text-xs text-red-500 hidden"></p>
        <div class="flex justify-end gap-2 pt-2">
          <button type="button" id="btn-cancel-edit" class="btn-secondary text-xs">Batal</button>
          <button type="submit" class="btn-primary text-xs">Simpan</button>
        </div>
      </form>
      </div>
    </div>
  </div>

  <!-- Modal History -->
  <div id="modal-history" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999;">
    <div id="history-backdrop" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; padding: 16px;">
      <div style="background: white; border-radius: 8px; padding: 20px; width: 100%; max-width: 500px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <h3 class="text-base font-semibold mb-3">Riwayat Perubahan</h3>
        <div id="history-content" class="text-xs"></div>
        <div class="flex justify-end pt-3">
          <button id="btn-close-history" class="btn-secondary text-xs">Tutup</button>
        </div>
      </div>
    </div>
  </div>
    </div>
  </div>

  <script>
    function getToken() { return localStorage.getItem('token'); }

    function formatDateTime(iso) {
      if (!iso) return '-';
      const isoWithZ = iso.endsWith('Z') ? iso : iso + 'Z';
      const d = new Date(isoWithZ);
      if (Number.isNaN(d.getTime())) return iso;
      return d.toLocaleString('id-ID', { 
        day: '2-digit', month: '2-digit', year: 'numeric',
        hour: '2-digit', minute: '2-digit',
        timeZone: 'Asia/Makassar'
      });
    }

    function formatCurrency(num) {
      return new Intl.NumberFormat('id-ID').format(num || 0);
    }

    // Get current month in YYYY-MM format (WITA)
    function getCurrentMonth() {
      const now = new Date();
      const witaTime = new Date(now.getTime() + (8 * 60 * 60 * 1000));
      return witaTime.toISOString().slice(0, 7);
    }

    // State
    let currentData = [];
    let outlets = [];
    let users = [];

    // Elements
    const filterMonth = document.getElementById('filter-month');
    const filterOutlet = document.getElementById('filter-outlet');
    const filterUser = document.getElementById('filter-user');
    const filterVerified = document.getElementById('filter-verified');
    const btnLoad = document.getElementById('btn-load');
    const btnExport = document.getElementById('btn-export');
    const dataBody = document.getElementById('data-body');
    const statusEl = document.getElementById('status');

    // Initialize
    filterMonth.value = getCurrentMonth();

    // Load outlets and users for dropdowns
    async function loadDropdowns() {
      try {
        const [outletRes, userRes] = await Promise.all([
          fetch('/api/admin/outlets', { headers: { 'Authorization': 'Bearer ' + getToken() } }),
          fetch('/api/admin/users', { headers: { 'Authorization': 'Bearer ' + getToken() } })
        ]);
        
        if (outletRes.ok) {
          outlets = await outletRes.json();
          filterOutlet.innerHTML = '<option value="">Semua Outlet</option>' +
            outlets.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
        }
        
        if (userRes.ok) {
          const allUsers = await userRes.json();
          users = allUsers.filter(u => u.role === 'produksi' || u.role === 'kurir');
          filterUser.innerHTML = '<option value="">Semua Staff</option>' +
            users.map(u => `<option value="${u.id}">${u.name}</option>`).join('');
        }
      } catch (e) {
        console.error('Error loading dropdowns:', e);
      }
    }

    // Load data
    async function loadData() {
      statusEl.textContent = 'Memuat data...';
      dataBody.innerHTML = '';
      
      const params = new URLSearchParams({ month: filterMonth.value });
      if (filterOutlet.value) params.set('outlet_id', filterOutlet.value);
      if (filterUser.value) params.set('user_id', filterUser.value);
      if (filterVerified.value !== 'all') params.set('verified', filterVerified.value);
      
      try {
        const [listRes, summaryRes] = await Promise.all([
          fetch('/api/admin/production-audit/list?' + params.toString(), {
            headers: { 'Authorization': 'Bearer ' + getToken() }
          }),
          fetch('/api/admin/production-audit/summary?' + params.toString(), {
            headers: { 'Authorization': 'Bearer ' + getToken() }
          })
        ]);
        
        if (!listRes.ok || !summaryRes.ok) {
          const err = await listRes.json().catch(() => ({}));
          statusEl.textContent = err.message || 'Gagal memuat data';
          return;
        }
        
        currentData = await listRes.json();
        const summary = await summaryRes.json();
        
        // Update summary cards
        document.getElementById('sum-weight').textContent = summary.total_weight.toFixed(1);
        document.getElementById('sum-qty').textContent = formatCurrency(summary.total_qty);
        document.getElementById('sum-verified').textContent = summary.verified_notas;
        document.getElementById('sum-unverified').textContent = summary.unverified_notas;
        
        // Update progress bar
        const total = summary.total_notas || 1;
        const percent = Math.round((summary.verified_notas / total) * 100);
        document.getElementById('progress-bar').style.width = percent + '%';
        document.getElementById('progress-text').textContent = percent + '%';
        
        // Render table grouped by nota
        renderTable(currentData);
        
        statusEl.textContent = currentData.length ? '' : 'Tidak ada data untuk periode ini.';
      } catch (e) {
        console.error('Error loading data:', e);
        statusEl.textContent = 'Terjadi kesalahan memuat data';
      }
    }

    function renderTable(data) {
      dataBody.innerHTML = '';
      
      // Group by nota_number + outlet_id
      const groups = {};
      data.forEach(row => {
        const key = row.nota_number + '-' + row.outlet_id;
        if (!groups[key]) {
          groups[key] = {
            nota_number: row.nota_number,
            outlet_id: row.outlet_id,
            outlet_name: row.outlet_name,
            verified_status: row.verified_status,
            entries: []
          };
        }
        groups[key].entries.push(row);
      });
      
      Object.values(groups).forEach(group => {
        const isVerified = group.verified_status === 'verified';
        const bgClass = isVerified ? 'bg-green-50' : '';
        
        // Calculate subtotals
        const subtotalQty = group.entries.reduce((sum, e) => sum + e.qty, 0);
        const subtotalWeight = group.entries.reduce((sum, e) => sum + e.weight, 0);
        
        // Render each entry in the group
        group.entries.forEach((row, idx) => {
          const tr = document.createElement('tr');
          tr.className = bgClass;
          
          // Show nota info only on first row of group
          const notaCell = idx === 0 
            ? `<td class="py-2 px-1 font-medium" rowspan="${group.entries.length}">${row.nota_number}</td>`
            : '';
          
          tr.innerHTML = `
            ${notaCell}
            <td class="py-2 px-1">${row.customer_name || '-'}</td>
            <td class="py-2 px-1">${row.user_name}</td>
            <td class="py-2 px-1">${row.outlet_name || '-'}</td>
            <td class="py-2 px-1">${row.process}</td>
            <td class="py-2 px-1 text-right">${row.qty}</td>
            <td class="py-2 px-1 text-right">${row.weight}</td>
            <td class="py-2 px-1 text-right">${formatCurrency(row.service_price)}</td>
            <td class="py-2 px-1">${formatDateTime(row.timestamp)}</td>
            <td class="py-2 px-1">
              ${isVerified 
                ? '<span class="inline-flex px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-[10px]">âœ“ Verified</span>'
                : '<span class="inline-flex px-2 py-0.5 rounded-full bg-orange-100 text-orange-700 text-[10px]">Pending</span>'
              }
            </td>
            <td class="py-2 px-1">
              <div class="flex gap-1">
                <button class="btn-edit text-[10px] px-2 py-1 bg-blue-50 text-blue-600 rounded hover:bg-blue-100" data-id="${row.id}">Edit</button>
                <button class="btn-history text-[10px] px-2 py-1 bg-slate-50 text-slate-600 rounded hover:bg-slate-100" data-id="${row.id}">History</button>
              </div>
            </td>
          `;
          dataBody.appendChild(tr);
        });
        
        // Add subtotal row
        const subTr = document.createElement('tr');
        subTr.className = 'bg-slate-100 font-medium';
        subTr.innerHTML = `
          <td class="py-1 px-1 text-right" colspan="5">Subtotal ${group.nota_number}:</td>
          <td class="py-1 px-1 text-right">${subtotalQty}</td>
          <td class="py-1 px-1 text-right">${subtotalWeight.toFixed(1)}</td>
          <td class="py-1 px-1" colspan="2"></td>
          <td class="py-1 px-1">
            <button class="btn-verify text-[10px] px-2 py-1 rounded ${isVerified ? 'bg-orange-50 text-orange-600 hover:bg-orange-100' : 'bg-green-50 text-green-600 hover:bg-green-100'}" 
                    data-nota="${group.nota_number}" data-outlet="${group.outlet_id}" data-verified="${isVerified}">
              ${isVerified ? 'Unverify' : 'Verify'}
            </button>
          </td>
        `;
        dataBody.appendChild(subTr);
      });
      
      // Add event listeners
      document.querySelectorAll('.btn-edit').forEach(btn => {
        btn.addEventListener('click', () => openEditModal(Number(btn.dataset.id)));
      });
      document.querySelectorAll('.btn-history').forEach(btn => {
        btn.addEventListener('click', () => openHistoryModal(Number(btn.dataset.id)));
      });
      document.querySelectorAll('.btn-verify').forEach(btn => {
        btn.addEventListener('click', () => toggleVerify(btn.dataset.nota, Number(btn.dataset.outlet), btn.dataset.verified === 'true'));
      });
    }

    // Edit Modal
    const modalEdit = document.getElementById('modal-edit');
    const editForm = document.getElementById('edit-form');
    const editError = document.getElementById('edit-error');

    function openEditModal(id) {
      const row = currentData.find(r => r.id === id);
      if (!row) return;
      
      document.getElementById('edit-id').value = row.id;
      document.getElementById('edit-customer').value = row.customer_name || '';
      document.getElementById('edit-nota').value = row.nota_number || '';
      document.getElementById('edit-process').value = row.process;
      document.getElementById('edit-qty').value = row.qty;
      document.getElementById('edit-weight').value = row.weight;
      document.getElementById('edit-price').value = row.service_price || 0;
      editError.classList.add('hidden');
      modalEdit.style.display = 'flex';
    }

    function closeEditModal() {
      modalEdit.style.display = 'none';
    }

    document.getElementById('btn-cancel-edit').addEventListener('click', closeEditModal);
    document.getElementById('edit-backdrop').addEventListener('click', closeEditModal);

    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      editError.classList.add('hidden');
      
      const id = document.getElementById('edit-id').value;
      const body = {
        customer_name: document.getElementById('edit-customer').value,
        nota_number: document.getElementById('edit-nota').value,
        process: document.getElementById('edit-process').value,
        qty: Number(document.getElementById('edit-qty').value),
        weight: Number(document.getElementById('edit-weight').value),
        service_price: Number(document.getElementById('edit-price').value)
      };
      
      try {
        const res = await fetch('/api/admin/production-audit/' + id, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
          },
          body: JSON.stringify(body)
        });
        
        const data = await res.json();
        if (res.ok) {
          closeEditModal();
          loadData();
        } else {
          editError.textContent = data.message || 'Gagal menyimpan';
          editError.classList.remove('hidden');
        }
      } catch (e) {
        editError.textContent = 'Terjadi kesalahan';
        editError.classList.remove('hidden');
      }
    });

    // History Modal
    const modalHistory = document.getElementById('modal-history');
    const historyContent = document.getElementById('history-content');

    async function openHistoryModal(id) {
      historyContent.innerHTML = 'Memuat...';
      modalHistory.style.display = 'flex';
      
      try {
        const res = await fetch('/api/admin/production-audit/history/' + id, {
          headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        
        if (!res.ok) {
          historyContent.innerHTML = 'Gagal memuat riwayat';
          return;
        }
        
        const history = await res.json();
        
        if (history.length === 0) {
          historyContent.innerHTML = '<p class="text-slate-500">Belum ada perubahan</p>';
          return;
        }
        
        historyContent.innerHTML = `
          <table class="w-full">
            <thead>
              <tr class="text-left text-slate-500 border-b">
                <th class="py-1">Admin</th>
                <th class="py-1">Waktu</th>
                <th class="py-1">Field</th>
                <th class="py-1">Nilai Lama</th>
                <th class="py-1">Nilai Baru</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              ${history.map(h => `
                <tr>
                  <td class="py-1">${h.admin_name}</td>
                  <td class="py-1">${formatDateTime(h.created_at)}</td>
                  <td class="py-1">${h.field_changed}</td>
                  <td class="py-1 text-red-600">${h.old_value || '-'}</td>
                  <td class="py-1 text-green-600">${h.new_value || '-'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      } catch (e) {
        historyContent.innerHTML = 'Terjadi kesalahan';
      }
    }

    function closeHistoryModal() {
      modalHistory.style.display = 'none';
    }

    document.getElementById('btn-close-history').addEventListener('click', closeHistoryModal);
    document.getElementById('history-backdrop').addEventListener('click', closeHistoryModal);

    // Verify/Unverify
    async function toggleVerify(notaNumber, outletId, isCurrentlyVerified) {
      const endpoint = isCurrentlyVerified ? '/api/admin/production-audit/unverify' : '/api/admin/production-audit/verify';
      
      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + getToken()
          },
          body: JSON.stringify({ nota_number: notaNumber, outlet_id: outletId })
        });
        
        const data = await res.json();
        if (res.ok) {
          loadData();
        } else {
          alert(data.message || 'Gagal mengubah status verifikasi');
        }
      } catch (e) {
        alert('Terjadi kesalahan');
      }
    }

    // Export
    btnExport.addEventListener('click', async () => {
      const params = new URLSearchParams({ month: filterMonth.value });
      if (filterOutlet.value) params.set('outlet_id', filterOutlet.value);
      if (filterUser.value) params.set('user_id', filterUser.value);
      if (filterVerified.value !== 'all') params.set('verified', filterVerified.value);
      
      try {
        const res = await fetch('/api/admin/production-audit/export?' + params.toString(), {
          headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          alert(err.message || 'Gagal export data');
          return;
        }
        
        // Get filename from Content-Disposition header
        const disposition = res.headers.get('Content-Disposition');
        let filename = 'audit-produksi.csv';
        if (disposition) {
          const match = disposition.match(/filename="(.+)"/);
          if (match) filename = match[1];
        }
        
        // Download the file
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
      } catch (e) {
        alert('Terjadi kesalahan saat export');
      }
    });

    // Event listeners
    btnLoad.addEventListener('click', loadData);

    // Initial load
    loadDropdowns().then(() => loadData());
  </script>
</body>
</html>
