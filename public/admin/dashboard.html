<!-- nav-v2 -->
<!doctype html>
<html lang="id" class="h-full">
<head>
  <link rel="icon" type="image/png" href="/icon.png" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard Admin - NearMe Laundry</title>
  <link rel="stylesheet" href="/styles.css" />
  <script src="/shared/nav.js" defer></script>
</head>
<body class="min-h-full flex flex-col bg-slate-100" onload="NearMeNav.ensureRole(['admin'])">
  <header class="bg-white shadow-sm">
    <div class="mx-auto max-w-5xl px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="/icon.png" alt="Logo NearMe Laundry" class="h-8 w-8 rounded-full object-cover" />
        <div>
          <div class="font-semibold text-primary text-sm">NearMe Laundry - Admin</div>
          <div class="text-[11px] text-slate-500">Mini ERP Laundry Harian</div>
        </div>
      </div>
      <nav class="flex items-center gap-3 text-[11px] text-slate-600"></nav>
      <script>document.addEventListener('DOMContentLoaded', () => NearMeNav.renderAdminNav('dashboard'));</script>
    </div>
  </header>

  <main class="flex-1 mx-auto w-full max-w-5xl px-4 py-4">
    <div class="mb-4 flex flex-col md:flex-row md:items-end md:justify-between gap-3">
      <div>
        <h1 class="text-lg font-semibold">Dashboard Admin</h1>
        <p class="text-xs text-slate-500">Ringkasan omzet, produksi, dan pengeluaran per bulan.</p>
      </div>
      <form id="filter-form" class="flex items-center gap-2 text-xs">
        <div>
          <label class="block text-slate-600 mb-1">Bulan</label>
          <input type="number" id="month" min="1" max="12" class="w-20 rounded-lg border border-slate-200 px-2 py-1" required />
        </div>
        <div>
          <label class="block text-slate-600 mb-1">Tahun</label>
          <input type="number" id="year" class="w-24 rounded-lg border border-slate-200 px-2 py-1" required />
        </div>
        <button type="submit" class="btn-secondary mt-4 md:mt-0">Terapkan</button>
      </form>
    </div>

    <!-- Ringkasan Biaya per Outlet -->
    <div class="card mb-4">
      <div class="text-xs text-slate-500 mb-2">ðŸ“Š Ringkasan Biaya per Outlet (% dari Omzet)</div>
      <div class="overflow-x-auto">
        <table class="w-full text-xs">
          <thead>
            <tr class="text-left text-slate-500 border-b">
              <th class="py-2">Outlet</th>
              <th class="py-2 text-right">Omzet</th>
              <th class="py-2 text-right">Gas</th>
              <th class="py-2 text-right">%</th>
              <th class="py-2 text-right">BHP</th>
              <th class="py-2 text-right">%</th>
              <th class="py-2 text-right">DLL</th>
              <th class="py-2 text-right">%</th>
              <th class="py-2 text-right">Gaji</th>
              <th class="py-2 text-right">%</th>
              <th class="py-2 text-right">Net Profit</th>
              <th class="py-2 text-right">%</th>
            </tr>
          </thead>
          <tbody id="outlet-summary-body" class="divide-y"></tbody>
          <tfoot id="outlet-summary-total" class="border-t-2 font-semibold"></tfoot>
        </table>
      </div>
    </div>

    <!-- Omzet Section -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-4">
      <div class="card">
        <div class="text-xs text-slate-500 mb-1">Total Omzet</div>
        <div id="total-omzet" class="text-xl font-semibold text-primary">Rp 0</div>
      </div>
      <div class="card md:col-span-2">
        <div class="text-xs text-slate-500 mb-1">Omzet per Outlet</div>
        <table class="w-full text-xs mt-1">
          <thead>
            <tr class="text-left text-slate-500 border-b">
              <th class="py-1">Outlet</th>
              <th class="py-1 text-right">Total</th>
            </tr>
          </thead>
          <tbody id="omzet-outlet-body" class="divide-y"></tbody>
        </table>
      </div>
    </div>

    <!-- Produksi Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
      <div class="card">
        <div class="text-xs text-slate-500 mb-2">ðŸ“Š Produksi per Proses</div>
        <table class="w-full text-xs">
          <thead>
            <tr class="text-left text-slate-500 border-b">
              <th class="py-1">Proses</th>
              <th class="py-1 text-right">Kg</th>
              <th class="py-1 text-right">Qty</th>
              <th class="py-1 text-right">Transaksi</th>
            </tr>
          </thead>
          <tbody id="production-process-body" class="divide-y"></tbody>
        </table>
        <div id="production-total" class="mt-2 pt-2 border-t text-xs font-semibold text-slate-600"></div>
      </div>
      <div class="card">
        <div class="text-xs text-slate-500 mb-2">ðŸ‘¤ Produksi per Staff</div>
        <table class="w-full text-xs">
          <thead>
            <tr class="text-left text-slate-500 border-b">
              <th class="py-1">Staff</th>
              <th class="py-1 text-right">Kg</th>
              <th class="py-1 text-right">Qty</th>
              <th class="py-1 text-right">Transaksi</th>
            </tr>
          </thead>
          <tbody id="production-staff-body" class="divide-y"></tbody>
        </table>
      </div>
    </div>

    <!-- Delivery Section -->
    <div class="card mb-4">
      <div class="text-xs text-slate-500 mb-2">ðŸšš Pengiriman (Antar/Jemput)</div>
      <div class="grid grid-cols-2 gap-3" id="delivery-summary">
        <div class="text-center p-3 bg-green-50 rounded-lg">
          <div class="text-2xl font-bold text-green-600" id="delivery-antar">0</div>
          <div class="text-xs text-slate-500">Antar</div>
        </div>
        <div class="text-center p-3 bg-blue-50 rounded-lg">
          <div class="text-2xl font-bold text-blue-600" id="delivery-jemput">0</div>
          <div class="text-xs text-slate-500">Jemput</div>
        </div>
      </div>
    </div>

    <!-- Pengeluaran Section -->
    <div class="card">
      <div class="text-xs text-slate-500 mb-1">ðŸ’° Pengeluaran per Kategori</div>
      <table class="w-full text-xs mt-1">
        <thead>
          <tr class="text-left text-slate-500 border-b">
            <th class="py-1">Kategori</th>
            <th class="py-1 text-right">Total</th>
          </tr>
        </thead>
        <tbody id="expense-body" class="divide-y"></tbody>
      </table>
      <div id="expense-total" class="mt-2 pt-2 border-t text-xs font-semibold text-slate-600"></div>
    </div>

    <p id="status" class="text-xs text-slate-600 mt-3"></p>
  </main>

  <script>
    function getToken() { return localStorage.getItem('token'); }
    function formatRupiah(v) { return 'Rp ' + (v || 0).toLocaleString('id-ID'); }

    const processLabels = {
      cuci: 'ðŸ§º Cuci', kering: 'â˜€ï¸ Keringkan', setrika: 'ðŸ‘” Setrika', packing: 'ðŸ“¦ Packing',
      cuci_sepatu: 'ðŸ‘Ÿ Cuci Sepatu', cuci_satuan: 'ðŸ‘• Cuci Satuan'
    };

    async function loadDashboard(month, year) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = 'Memuat data...';
      try {
        const res = await fetch(`/api/dashboard?month=${month}&year=${year}`, {
          headers: { 'Authorization': 'Bearer ' + getToken() },
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          statusEl.textContent = data.message || 'Gagal memuat data';
          return;
        }

        // Ringkasan Biaya per Outlet
        const outletSummaryBody = document.getElementById('outlet-summary-body');
        const outletSummaryTotal = document.getElementById('outlet-summary-total');
        outletSummaryBody.innerHTML = '';
        (data.outletSummary || []).forEach(row => {
          const profitClass = row.net_profit >= 0 ? 'color:#16a34a' : 'color:#dc2626';
          const profitBg = row.net_profit >= 0 ? 'background:#dcfce7' : 'background:#fee2e2';
          outletSummaryBody.innerHTML += `<tr>
            <td class="py-2">${row.outlet}</td>
            <td class="py-2 text-right">${formatRupiah(row.omzet)}</td>
            <td class="py-2 text-right">${formatRupiah(row.gas_total)}</td>
            <td class="py-2 text-right"><span style="display:inline-block;padding:2px 8px;border-radius:4px;background:#e2e8f0;color:#334155">${row.gas_percent}%</span></td>
            <td class="py-2 text-right">${formatRupiah(row.bhp_total)}</td>
            <td class="py-2 text-right"><span style="display:inline-block;padding:2px 8px;border-radius:4px;background:#e2e8f0;color:#334155">${row.bhp_percent}%</span></td>
            <td class="py-2 text-right">${formatRupiah(row.dll_total)}</td>
            <td class="py-2 text-right"><span style="display:inline-block;padding:2px 8px;border-radius:4px;background:#e2e8f0;color:#334155">${row.dll_percent}%</span></td>
            <td class="py-2 text-right">${formatRupiah(row.gaji_total)}</td>
            <td class="py-2 text-right"><span style="display:inline-block;padding:2px 8px;border-radius:4px;background:#e2e8f0;color:#334155">${row.gaji_percent}%</span></td>
            <td class="py-2 text-right font-semibold" style="${profitClass}">${formatRupiah(row.net_profit)}</td>
            <td class="py-2 text-right"><span style="display:inline-block;padding:2px 8px;border-radius:4px;${profitBg};${profitClass};font-weight:600">${row.net_profit_percent}%</span></td>
          </tr>`;
        });
        // Total row
        const ts = data.totalSummary || {};
        const totalProfitClass = ts.net_profit >= 0 ? 'color:#16a34a' : 'color:#dc2626';
        const totalProfitBg = ts.net_profit >= 0 ? 'background:#dcfce7' : 'background:#fee2e2';
        outletSummaryTotal.innerHTML = `<tr>
          <td class="py-2">TOTAL</td>
          <td class="py-2 text-right">${formatRupiah(ts.omzet)}</td>
          <td class="py-2 text-right">${formatRupiah(ts.gas_total)}</td>
          <td class="py-2 text-right"><span style="display:inline-block;padding:2px 8px;border-radius:4px;background:#e2e8f0;color:#334155">${ts.gas_percent}%</span></td>
          <td class="py-2 text-right">${formatRupiah(ts.bhp_total)}</td>
          <td class="py-2 text-right"><span style="display:inline-block;padding:2px 8px;border-radius:4px;background:#e2e8f0;color:#334155">${ts.bhp_percent}%</span></td>
          <td class="py-2 text-right">${formatRupiah(ts.dll_total)}</td>
          <td class="py-2 text-right"><span style="display:inline-block;padding:2px 8px;border-radius:4px;background:#e2e8f0;color:#334155">${ts.dll_percent}%</span></td>
          <td class="py-2 text-right">${formatRupiah(ts.gaji_total)}</td>
          <td class="py-2 text-right"><span style="display:inline-block;padding:2px 8px;border-radius:4px;background:#e2e8f0;color:#334155">${ts.gaji_percent}%</span></td>
          <td class="py-2 text-right font-semibold" style="${totalProfitClass}">${formatRupiah(ts.net_profit)}</td>
          <td class="py-2 text-right"><span style="display:inline-block;padding:2px 8px;border-radius:4px;${totalProfitBg};${totalProfitClass};font-weight:600">${ts.net_profit_percent}%</span></td>
        </tr>`;

        // Omzet
        document.getElementById('total-omzet').textContent = formatRupiah(data.totalRevenue || 0);
        const omzetBody = document.getElementById('omzet-outlet-body');
        omzetBody.innerHTML = '';
        (data.revenuePerOutlet || []).forEach(row => {
          omzetBody.innerHTML += `<tr><td class="py-1">${row.outlet}</td><td class="py-1 text-right">${formatRupiah(row.total)}</td></tr>`;
        });

        // Produksi per Proses
        const prodProcessBody = document.getElementById('production-process-body');
        prodProcessBody.innerHTML = '';
        let totalKg = 0, totalQty = 0, totalTrx = 0;
        (data.productionByProcess || []).forEach(row => {
          prodProcessBody.innerHTML += `<tr>
            <td class="py-1">${processLabels[row.process] || row.process}</td>
            <td class="py-1 text-right">${(row.total_kg || 0).toFixed(1)}</td>
            <td class="py-1 text-right">${row.total_qty || 0}</td>
            <td class="py-1 text-right">${row.total_transaksi || 0}</td>
          </tr>`;
          totalKg += row.total_kg || 0;
          totalQty += row.total_qty || 0;
          totalTrx += row.total_transaksi || 0;
        });
        document.getElementById('production-total').innerHTML = data.productionByProcess?.length
          ? `Total: ${totalKg.toFixed(1)} kg, ${totalQty} pcs, ${totalTrx} transaksi`
          : 'Belum ada data produksi';

        // Produksi per Staff
        const prodStaffBody = document.getElementById('production-staff-body');
        prodStaffBody.innerHTML = '';
        (data.productionByStaff || []).forEach(row => {
          prodStaffBody.innerHTML += `<tr>
            <td class="py-1">${row.staff}</td>
            <td class="py-1 text-right">${(row.total_kg || 0).toFixed(1)}</td>
            <td class="py-1 text-right">${row.total_qty || 0}</td>
            <td class="py-1 text-right">${row.total_transaksi || 0}</td>
          </tr>`;
        });
        if (!data.productionByStaff?.length) {
          prodStaffBody.innerHTML = '<tr><td colspan="4" class="py-2 text-center text-slate-400">Belum ada data</td></tr>';
        }

        // Delivery
        let antarTotal = 0, jemputTotal = 0;
        (data.deliverySummary || []).forEach(row => {
          if (row.type === 'antar') antarTotal = row.total || 0;
          if (row.type === 'jemput') jemputTotal = row.total || 0;
        });
        document.getElementById('delivery-antar').textContent = antarTotal;
        document.getElementById('delivery-jemput').textContent = jemputTotal;

        // Pengeluaran
        const expenseBody = document.getElementById('expense-body');
        expenseBody.innerHTML = '';
        let totalExpense = 0;
        (data.expensesByCategory || []).forEach(row => {
          expenseBody.innerHTML += `<tr><td class="py-1">${row.category}</td><td class="py-1 text-right">${formatRupiah(row.total)}</td></tr>`;
          totalExpense += row.total || 0;
        });
        document.getElementById('expense-total').innerHTML = data.expensesByCategory?.length
          ? `Total Pengeluaran: ${formatRupiah(totalExpense)}`
          : 'Belum ada pengeluaran';

        statusEl.textContent = '';
      } catch {
        statusEl.textContent = 'Terjadi kesalahan memuat data';
      }
    }

    const form = document.getElementById('filter-form');
    const monthInput = document.getElementById('month');
    const yearInput = document.getElementById('year');
    const today = new Date();
    monthInput.value = today.getMonth() + 1;
    yearInput.value = today.getFullYear();

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      loadDashboard(Number(monthInput.value), Number(yearInput.value));
    });

    loadDashboard(today.getMonth() + 1, today.getFullYear());
  </script>
</body>
</html>
 

